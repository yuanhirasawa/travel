<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>旅遊大師 TravelMaster</title>
    <!-- 必要的行動裝置設定：PWA 支援 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="theme-color" content="#F8FAFC">
    
    <!-- CDN 載入 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase 配置
        const firebaseConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : {
            apiKey: "", 
            authDomain: "",
            projectId: "",
            storageBucket: "",
            messagingSenderId: "",
            appId: ""
        };

        window.FB_TOOLS = { initializeApp, getAuth, signInAnonymously, onAuthStateChanged, getFirestore, doc, onSnapshot, setDoc, firebaseConfig };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F8FAFC; -webkit-tap-highlight-color: transparent; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        input, textarea, select { font-size: 16px !important; border: none !important; outline: none !important; }
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;
        const ACCENT_COLOR = '#FF7E00';

        // --- 1. 定義輔助函式與資料範本 ---
        const createNewTripTemplate = (title, startDate) => ({
            id: Date.now().toString(),
            title: title || "未命名旅程",
            startDate: startDate || new Date().toISOString().split('T')[0],
            createdAt: Date.now(),
            itineraries: [{ id: '1', date: startDate || new Date().toISOString().split('T')[0], events: [] }],
            ledger: [],
            checklist: [{ id: 'c1', item: '護照', checked: false }],
            documents: [],
            shoppingList: [],
            memo: '這裡是備忘錄，可以記下飯店地址或重要提醒...'
        });

        // --- 2. 基礎 UI 元件 ---
        const GlassCard = ({ children, className = '', onClick }) => (
            <div className={`bg-white border border-slate-200 rounded-[2.5rem] shadow-sm hover:shadow-md transition-all duration-300 ${className}`} onClick={onClick}>
                {children}
            </div>
        );

        const PrimaryButton = ({ children, className = '', onClick, disabled = false }) => (
            <button disabled={disabled} className={`bg-orange-500 text-white font-bold py-4 px-6 rounded-2xl shadow-lg shadow-orange-100 hover:bg-orange-600 active:scale-95 transition-all disabled:opacity-50 ${className}`} onClick={onClick} style={{backgroundColor: ACCENT_COLOR}}>
                {children}
            </button>
        );

        const CustomToast = ({ message, visible }) => {
            if (!visible || !message) return null;
            return (
                <div className="fixed top-6 left-1/2 -translate-x-1/2 z-[400] px-6 py-3 rounded-full font-bold shadow-2xl bg-slate-800 text-white animate-bounce text-sm text-center">
                    {typeof message === 'string' ? message : '操作成功'}
                </div>
            );
        };

        const ModalWrapper = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-slate-900/40 z-[300] flex items-center justify-center p-4 backdrop-blur-sm" onClick={onClose}>
                    <div className="bg-white w-full max-w-lg rounded-[3rem] shadow-2xl overflow-hidden animate-fade-in" onClick={e => e.stopPropagation()}>
                        <div className="px-8 py-6 border-b border-slate-100 flex justify-between items-center">
                            <h2 className="text-xl font-bold text-slate-800">{title}</h2>
                            <button onClick={onClose} className="text-slate-400 hover:text-slate-600"><i className="fas fa-times text-lg"></i></button>
                        </div>
                        <div className="p-8 overflow-y-auto max-h-[75vh]">{children}</div>
                    </div>
                </div>
            );
        };

        // --- 3. 核心表單組件 (支援新增與編輯) ---
        const ItemFormContent = ({ view, activeTrip, onUpdate, onClose, showToast, editItem = null }) => {
            const [date, setDate] = useState(editItem?.date || new Date().toISOString().split('T')[0]);
            const [time, setTime] = useState(editItem?.time || '12:00');
            const [text, setText] = useState(editItem?.activity || editItem?.description || editItem?.title || editItem?.item || '');
            const [amount, setAmount] = useState(editItem?.foreignAmount || editItem?.price || '');
            const [shop, setShop] = useState(editItem?.shop || editItem?.content || '');
            const [image, setImage] = useState(editItem?.image || (editItem?.type === 'image' ? editItem.content : ''));
            const [currency, setCurrency] = useState(editItem?.currency || 'JPY');
            const [rate, setRate] = useState(editItem?.rate || 0.21);

            const currencies = [
                { code: 'JPY', name: '日幣', symbol: '¥', defaultRate: 0.21 },
                { code: 'KRW', name: '韓元', symbol: '₩', defaultRate: 0.024 },
                { code: 'USD', name: '美金', symbol: '$', defaultRate: 32.5 },
                { code: 'EUR', name: '歐元', symbol: '€', defaultRate: 35.0 },
                { code: 'HKD', name: '港幣', symbol: 'HK$', defaultRate: 4.1 },
                { code: 'TWD', name: '台幣', symbol: 'NT$', defaultRate: 1.0 },
            ];

            const handleFileUpload = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (upload) => setImage(upload.target.result);
                reader.readAsDataURL(file);
            };

            const saveChanges = (key, dataProcessor) => {
                const list = [...(activeTrip[key] || [])];
                const processedItem = dataProcessor();
                
                if (editItem) {
                    const idx = list.findIndex(i => i.id === editItem.id);
                    if (idx > -1) list[idx] = { ...list[idx], ...processedItem };
                } else {
                    list.push({ id: Date.now().toString(), ...processedItem });
                }
                
                onUpdate({ ...activeTrip, [key]: list });
                onClose();
                showToast(editItem ? '已成功更新' : '已成功新增');
            };

            if (view === 'itinerary') return (
                <div className="space-y-4">
                    <div><label className="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-widest">日期</label><input type="date" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" value={date} onChange={e => setDate(e.target.value)} /></div>
                    <div><label className="text-xs font-bold text-slate-400 mb-2 block uppercase tracking-widest">時間</label><input type="time" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" value={time} onChange={e => setTime(e.target.value)} /></div>
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="活動內容" value={text} onChange={e => setText(e.target.value)} />
                    <PrimaryButton className="w-full" onClick={() => {
                        const newItins = [...(activeTrip.itineraries || [])];
                        const eventObj = { time, activity: text };
                        if (editItem) {
                            const updated = newItins.map(itin => ({
                                ...itin,
                                events: itin.events.map(ev => (ev === editItem ? eventObj : ev))
                            }));
                            onUpdate({...activeTrip, itineraries: updated});
                        } else {
                            const idx = newItins.findIndex(i => i.date === date);
                            if (idx > -1) newItins[idx].events = [...(newItins[idx].events || []), eventObj];
                            else newItins.push({id: Date.now().toString(), date, events:[eventObj]});
                            onUpdate({...activeTrip, itineraries: newItins});
                        }
                        onClose();
                        showToast('行程已儲存');
                    }}>確認儲存</PrimaryButton>
                </div>
            );

            if (view === 'accounting') return (
                <div className="space-y-4">
                    <input type="date" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" value={date} onChange={e => setDate(e.target.value)} />
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="支出項目描述" value={text} onChange={e => setText(e.target.value)} />
                    <div className="grid grid-cols-2 gap-3">
                        <select className="w-full p-4 bg-slate-50 rounded-2xl font-bold" value={currency} onChange={e => {
                            const c = e.target.value;
                            setCurrency(c);
                            setRate(currencies.find(cur => cur.code === c)?.defaultRate || 1.0);
                        }}>
                            {currencies.map(c => <option key={c.code} value={c.code}>{c.name}</option>)}
                        </select>
                        <div className="relative">
                            <input type="number" className="w-full p-4 bg-slate-50 rounded-2xl font-bold pr-8" placeholder="金額" value={amount} onChange={e => setAmount(e.target.value)} />
                            <span className="absolute right-4 top-1/2 -translate-y-1/2 font-bold text-slate-300">{currencies.find(c=>c.code===currency)?.symbol}</span>
                        </div>
                    </div>
                    <div><label className="text-[10px] font-bold text-slate-400 mb-1 block uppercase tracking-widest">當前匯率 (1 {currency} = ? TWD)</label><input type="number" step="0.0001" className="w-full p-4 bg-slate-50 rounded-2xl font-bold" value={rate} onChange={e => setRate(e.target.value)} /></div>
                    <div className="p-4 bg-orange-50 rounded-2xl text-center border border-orange-100">
                        <p className="text-[10px] font-bold text-orange-400 uppercase tracking-widest mb-1">台幣預估金額</p>
                        <p className="text-xl font-black text-orange-600">${Math.round((parseFloat(amount) || 0) * (parseFloat(rate) || 0)).toLocaleString()} TWD</p>
                    </div>
                    <PrimaryButton className="w-full" onClick={() => saveChanges('ledger', () => ({
                        description: text, foreignAmount: parseFloat(amount), currency, twd: Math.round(parseFloat(amount) * parseFloat(rate)), date, rate: parseFloat(rate)
                    }))}>儲存帳目</PrimaryButton>
                </div>
            );

            if (view === 'shopping') return (
                <div className="space-y-4">
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="商品名稱" value={text} onChange={e => setText(e.target.value)} />
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="購買店家" value={shop} onChange={e => setShop(e.target.value)} />
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="預估價格" value={amount} onChange={e => setAmount(e.target.value)} />
                    <div className="border-2 border-dashed border-slate-100 p-8 text-center rounded-2xl bg-slate-50 relative group">
                        <input type="file" onChange={handleFileUpload} className="absolute inset-0 opacity-0 cursor-pointer" accept="image/*" />
                        <i className="fas fa-camera text-2xl text-slate-300"></i>
                        <p className="text-xs font-bold text-slate-400 mt-2">更新參考圖片</p>
                    </div>
                    {image && <img src={image} className="h-32 mx-auto rounded-2xl shadow-md border-4 border-white" />}
                    <PrimaryButton className="w-full" onClick={() => saveChanges('shoppingList', () => ({ title: text, shop, price: amount, image, checked: editItem?.checked || false }))}>儲存清單</PrimaryButton>
                </div>
            );

            if (view === 'checklist') return (
                <div className="space-y-4">
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="準備項目" value={text} onChange={e => setText(e.target.value)} />
                    <PrimaryButton className="w-full" onClick={() => saveChanges('checklist', () => ({ item: text, checked: editItem?.checked || false }))}>儲存項目</PrimaryButton>
                </div>
            );

            if (view === 'documents') return (
                <div className="space-y-4">
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="文件標題" value={text} onChange={e => setText(e.target.value)} />
                    <div className="border-2 border-dashed border-slate-100 p-10 text-center rounded-2xl bg-slate-50 relative">
                        <input type="file" onChange={handleFileUpload} className="absolute inset-0 opacity-0" accept="image/*" />
                        <i className="fas fa-file-invoice text-2xl text-slate-300"></i>
                        <p className="text-xs font-bold text-slate-400 mt-2">更換憑證圖片</p>
                    </div>
                    <div className="text-center text-xs font-black text-slate-200 uppercase tracking-widest">或貼上連結</div>
                    <input className="w-full p-4 bg-slate-50 rounded-2xl font-bold" placeholder="雲端網址" value={shop} onChange={e => setShop(e.target.value)} />
                    <PrimaryButton className="w-full" onClick={() => saveChanges('documents', () => ({ title: text, content: image || shop, type: image ? 'image' : 'link', date: date }))}>儲存文件</PrimaryButton>
                </div>
            );

            return null;
        };

        // --- 4. 主程式 App ---
        const App = () => {
            const { FB_TOOLS } = window;
            const [appState, setAppState] = useState({ trips: [] });
            const [activeTripId, setActiveTripId] = useState(null);
            const [view, setView] = useState('home');
            const [db, setDb] = useState(null);
            const [userId, setUserId] = useState(null);
            const [selectedDateTab, setSelectedDateTab] = useState('');
            const [isAddTripOpen, setIsAddTripOpen] = useState(false);
            const [isFormModalOpen, setIsFormModalOpen] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [toast, setToast] = useState({ msg: '', visible: false });

            const activeTrip = useMemo(() => {
                if (!appState.trips) return null;
                const trip = appState.trips.find(t => t.id === activeTripId);
                if (trip && !selectedDateTab && trip.itineraries?.length > 0) setSelectedDateTab(trip.itineraries[0].date);
                return trip || null;
            }, [appState.trips, activeTripId, selectedDateTab]);

            const totalSpending = useMemo(() => {
                if (!activeTrip?.ledger) return 0;
                return activeTrip.ledger.reduce((sum, item) => sum + (item.twd || 0), 0);
            }, [activeTrip?.ledger]);

            const showToast = (msg) => {
                setToast({ msg, visible: true });
                setTimeout(() => setToast({ msg: '', visible: false }), 3000);
            };

            const updateAppState = (newState) => {
                if (!db || !userId) return;
                const docId = window.__app_id || 'default-travel-master';
                FB_TOOLS.setDoc(FB_TOOLS.doc(db, 'artifacts', docId, 'users', userId, 'travel_data', 'travel_plan'), newState);
            };

            const updateActiveTrip = (updatedTrip) => {
                const newTrips = (appState.trips || []).map(t => t.id === updatedTrip.id ? updatedTrip : t);
                updateAppState({ ...appState, trips: newTrips });
            };

            useEffect(() => {
                if (!FB_TOOLS) return;
                const app = FB_TOOLS.initializeApp(FB_TOOLS.firebaseConfig);
                const firestore = FB_TOOLS.getFirestore(app);
                const auth = FB_TOOLS.getAuth(app);
                setDb(firestore);
                FB_TOOLS.onAuthStateChanged(auth, async (user) => {
                    if (user) setUserId(user.uid);
                    else await FB_TOOLS.signInAnonymously(auth);
                });
            }, []);

            useEffect(() => {
                if (!db || !userId) return;
                const docId = window.__app_id || 'default-travel-master';
                const dataDocRef = FB_TOOLS.doc(db, 'artifacts', docId, 'users', userId, 'travel_data', 'travel_plan');
                return FB_TOOLS.onSnapshot(dataDocRef, (snap) => {
                    if (snap.exists()) setAppState(snap.data());
                    else FB_TOOLS.setDoc(dataDocRef, { trips: [] });
                });
            }, [db, userId]);

            const renderTripList = () => (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="flex justify-between items-end px-2">
                        <div><h1 className="text-3xl font-black text-slate-800 tracking-tight">我的旅程</h1><p className="text-slate-400 font-bold">記錄下每一段難忘的時光</p></div>
                        <button onClick={() => setIsAddTripOpen(true)} className="w-16 h-16 bg-orange-500 text-white rounded-[1.8rem] shadow-xl flex items-center justify-center text-2xl active:scale-90 transition-all"><i className="fas fa-plus"></i></button>
                    </div>
                    <div className="grid grid-cols-1 gap-6 pb-20">
                        {(appState.trips || []).map(trip => {
                            const diff = new Date(trip.startDate) - new Date();
                            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));
                            return (
                                <GlassCard key={trip.id} className="p-8 cursor-pointer group relative overflow-hidden" onClick={() => { setActiveTripId(trip.id); setView('home'); }}>
                                    <div className="flex justify-between items-start mb-6">
                                        <div className="flex-1"><h2 className="text-2xl font-black text-slate-800 mb-1">{trip.title}</h2><p className="text-xs font-bold text-slate-300 uppercase tracking-widest">{trip.startDate}</p></div>
                                        <div className={`px-4 py-2 rounded-full font-black text-[10px] ${days > 0 ? 'bg-orange-50 text-orange-500' : 'bg-slate-50 text-slate-300'}`}>{days > 0 ? `T-${days} DAYS` : '旅行中 / 已結束'}</div>
                                    </div>
                                    <div className="flex space-x-6 text-xs font-black text-slate-400 uppercase">
                                        <span><i className="far fa-calendar-alt mr-2 text-orange-400"></i>{(trip.itineraries || []).length} 天行程</span>
                                        <span><i className="fas fa-receipt mr-2 text-blue-400"></i>{(trip.ledger || []).length} 筆帳務</span>
                                    </div>
                                    <div className="absolute top-0 left-0 w-2 h-full bg-orange-500 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                                </GlassCard>
                            );
                        })}
                    </div>
                </div>
            );

            const renderHome = () => {
                if (!activeTrip) return null;
                const todayEvents = activeTrip.itineraries?.find(i => i.date === selectedDateTab)?.events?.slice(0, 3) || [];
                const unchecked = activeTrip.checklist?.filter(i => !i.checked) || [];
                const progress = activeTrip.checklist?.length ? Math.round(((activeTrip.checklist.length - unchecked.length) / activeTrip.checklist.length) * 100) : 0;
                
                return (
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6 animate-fade-in pb-24">
                        <GlassCard className="md:col-span-3 p-10 bg-gradient-to-br from-orange-50 to-white border-orange-100 flex justify-between items-center">
                            <div><h2 className="text-3xl font-black text-slate-800 tracking-tighter uppercase">Countdown</h2><p className="text-sm font-bold text-orange-500">{activeTrip.startDate}</p></div>
                            <div className="text-right"><span className="text-7xl font-black text-orange-500 tracking-tighter">{Math.max(0, Math.ceil((new Date(activeTrip.startDate) - new Date()) / (1000 * 60 * 60 * 24)))}</span><span className="text-xl font-black text-slate-400 ml-2 uppercase">Days</span></div>
                        </GlassCard>

                        <GlassCard className="md:col-span-2 p-6" onClick={() => setView('itinerary')}>
                            <div className="flex justify-between items-center mb-6"><h2 className="text-xl font-bold text-slate-800">今日行程快報</h2><span className="text-xs font-bold text-orange-500 bg-orange-50 px-3 py-1 rounded-full">{selectedDateTab}</span></div>
                            <div className="space-y-4">
                                {todayEvents.length > 0 ? todayEvents.map((e,idx)=>(
                                    <div key={idx} className="flex items-center text-slate-700 font-bold bg-slate-50 p-4 rounded-3xl border border-slate-100"><span className="text-orange-500 mr-4 w-12 text-sm">{e.time}</span><span className="flex-1 truncate">{e.activity}</span></div>
                                )) : <p className="text-slate-400 italic">點擊開始規劃行程吧！</p>}
                            </div>
                        </GlassCard>

                        <GlassCard className="p-6 bg-slate-900 text-white shadow-2xl" onClick={() => setView('accounting')}>
                            <h2 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-2">消費累積總額</h2>
                            <div className="text-4xl font-black tracking-tighter mb-2">${totalSpending.toLocaleString()}</div>
                            <div className="mt-8 flex justify-end text-orange-500"><i className="fas fa-coins text-2xl"></i></div>
                        </GlassCard>

                        <GlassCard className="p-6 bg-orange-50 border-orange-100 flex flex-col min-h-[260px]">
                            <div className="flex justify-between items-center mb-4 text-orange-800"><h2 className="text-lg font-bold">旅遊備忘錄</h2><i className="fas fa-sticky-note opacity-30"></i></div>
                            <textarea className="bg-transparent flex-1 w-full text-sm font-medium text-orange-900 focus:outline-none resize-none leading-relaxed placeholder:text-orange-200" value={activeTrip.memo || ''} placeholder="在此記下細節..." onChange={(e) => updateActiveTrip({ ...activeTrip, memo: e.target.value })} />
                        </GlassCard>

                        <GlassCard className="p-6 flex flex-col justify-between" onClick={() => setView('checklist')}>
                            <div><h2 className="text-lg font-bold text-slate-800 mb-2 text-center">打包進度：{progress}%</h2><div className="w-full bg-slate-100 h-2 rounded-full overflow-hidden mb-4"><div className="h-full bg-orange-500 transition-all duration-1000" style={{width:`${progress}%`}}></div></div>
                            <div className="space-y-1 text-slate-400">{unchecked.slice(0, 2).map((item, i) => <p key={i} className="text-[10px] font-bold truncate">· {item.item}</p>)}</div></div>
                        </GlassCard>

                        <GlassCard className="p-6 flex flex-col justify-between" onClick={() => setView('shopping')}>
                            <h2 className="text-lg font-bold text-slate-800 mb-3 text-center">想要購買</h2>
                            <div className="space-y-3">
                                {(activeTrip.shoppingList || []).slice(0, 2).map((item, i) => (
                                    <div key={i} className="flex items-center text-xs bg-slate-50 p-2 rounded-2xl border border-slate-100">
                                        <div className="flex-1 truncate"><p className="font-bold text-slate-700">{item.title}</p><p className="text-orange-500 font-black">¥{item.price}</p></div>
                                    </div>
                                ))}
                            </div>
                        </GlassCard>
                    </div>
                );
            };

            const renderActiveView = () => {
                if (!activeTripId) return renderTripList();
                if (view === 'home') return renderHome();
                
                return (
                    <div className="space-y-8 animate-fade-in pb-20">
                        <div className="flex justify-between items-center border-b border-slate-100 pb-6">
                            <h1 className="text-4xl font-black text-slate-800 tracking-tighter uppercase italic tracking-widest">{view}</h1>
                            <button onClick={() => { setEditingItem(null); setIsFormModalOpen(true); }} className="bg-orange-50 text-orange-600 px-5 py-2 rounded-xl font-bold text-sm">新增</button>
                        </div>

                        {view === 'itinerary' && (
                            <div className="space-y-6">
                                <div className="flex space-x-3 overflow-x-auto pb-4 no-scrollbar">
                                    {[...(activeTrip.itineraries || [])].sort((a,b)=>new Date(a.date)-new Date(b.date)).map(itin => (
                                        <button key={itin.id} onClick={() => setSelectedDateTab(itin.date)} className={`px-6 py-3 rounded-2xl font-bold whitespace-nowrap transition-all border ${selectedDateTab === itin.date ? 'bg-orange-500 text-white border-orange-500 shadow-xl' : 'bg-white text-slate-400 border-slate-200'}`}>{itin.date.split('-').slice(1).join('/')}</button>
                                    ))}
                                </div>
                                <div className="space-y-4">
                                    <h3 className="text-xl font-black text-slate-800 mb-6 flex items-center tracking-widest"><span className="w-3 h-8 bg-orange-500 rounded-full mr-4"></span>{selectedDateTab}</h3>
                                    {(activeTrip.itineraries?.find(i=>i.date===selectedDateTab)?.events || []).sort((a,b)=>a.time.localeCompare(b.time)).map((e, idx) => (
                                        <GlassCard key={idx} className="p-6 flex justify-between items-center bg-white group border-slate-100">
                                            <div className="flex items-center"><div className="w-16 h-12 bg-slate-50 rounded-2xl flex items-center justify-center font-black text-orange-500 text-sm mr-6">{e.time}</div><span className="font-bold text-slate-700 text-lg">{e.activity}</span></div>
                                            <div className="flex space-x-4 opacity-0 group-hover:opacity-100 transition-all">
                                                <button onClick={() => { setEditingItem(e); setIsFormModalOpen(true); }} className="text-slate-300 hover:text-orange-500"><i className="fas fa-pencil-alt"></i></button>
                                                <button onClick={() => { const newItins = activeTrip.itineraries.map(i => i.date === selectedDateTab ? {...i, events: i.events.filter(ev=>ev!==e)} : i); updateActiveTrip({...activeTrip, itineraries: newItins}); }} className="text-slate-300 hover:text-red-400"><i className="fas fa-trash-alt"></i></button>
                                            </div>
                                        </GlassCard>
                                    ))}
                                </div>
                            </div>
                        )}

                        {view === 'accounting' && (
                            <div className="space-y-4">
                                {(activeTrip.ledger || []).slice().reverse().map(e => (
                                    <GlassCard key={e.id} className="p-6 flex justify-between items-center bg-white group border-slate-100">
                                        <div><h3 className="font-bold text-slate-800 text-lg mb-1">{e.description}</h3><p className="text-xs font-bold text-slate-400 uppercase tracking-widest">{e.date} | {e.foreignAmount?.toLocaleString()} {e.currency} (匯率: {e.rate})</p></div>
                                        <div className="flex items-center space-x-8 text-right">
                                            <p className="text-2xl font-black text-slate-800 tracking-tighter">${e.twd?.toLocaleString()} <span className="text-[10px] text-slate-300 uppercase">Twd</span></p>
                                            <div className="flex space-x-4 opacity-0 group-hover:opacity-100 transition-all">
                                                <button onClick={() => { setEditingItem(e); setIsFormModalOpen(true); }} className="text-slate-300 hover:text-orange-500"><i className="fas fa-pencil-alt"></i></button>
                                                <button onClick={() => updateActiveTrip({...activeTrip, ledger: activeTrip.ledger.filter(l=>l.id!==e.id)})} className="text-slate-300 hover:text-red-400"><i className="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                    </GlassCard>
                                ))}
                            </div>
                        )}

                        {view === 'shopping' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-8">
                                {(activeTrip.shoppingList || []).map(item => (
                                    <GlassCard key={item.id} className="p-6 bg-white flex flex-col group relative">
                                        {item.image && <img src={item.image} className="w-full h-56 object-cover rounded-[2rem] mb-6 border border-slate-50" />}
                                        <div className="flex justify-between items-start mb-2"><h3 className="text-2xl font-black text-slate-800 tracking-tight">{item.title}</h3>
                                            <div className="flex space-x-4 opacity-0 group-hover:opacity-100 transition-all">
                                                <button onClick={() => { setEditingItem(item); setIsFormModalOpen(true); }} className="text-slate-300 hover:text-orange-500"><i className="fas fa-pencil-alt"></i></button>
                                                <button onClick={() => updateActiveTrip({...activeTrip, shoppingList: activeTrip.shoppingList.filter(s=>s.id!==item.id)})} className="text-slate-200 hover:text-red-400"><i className="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        <p className="text-sm font-bold text-orange-500 mb-1">{item.shop || '未指定'}</p>
                                        <p className="text-3xl font-black text-slate-700 tracking-tighter">¥{item.price}</p>
                                    </GlassCard>
                                ))}
                            </div>
                        )}

                        {view === 'documents' && (
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-8">
                                {(activeTrip.documents || []).map(doc => (
                                    <GlassCard key={doc.id} className="p-6 bg-white group border-slate-100">
                                        <div className="flex justify-between items-start mb-6"><h3 className="font-bold text-slate-800 text-xl">{doc.title}</h3>
                                            <div className="flex space-x-4 opacity-0 group-hover:opacity-100 transition-all">
                                                <button onClick={() => { setEditingItem(doc); setIsFormModalOpen(true); }} className="text-slate-300 hover:text-orange-500"><i className="fas fa-pencil-alt"></i></button>
                                                <button onClick={() => updateActiveTrip({...activeTrip, documents: activeTrip.documents.filter(d=>d.id!==doc.id)})} className="text-slate-200 hover:text-red-400"><i className="fas fa-trash-alt"></i></button>
                                            </div>
                                        </div>
                                        {doc.type === 'image' ? <img src={doc.content} className="w-full h-auto rounded-[2rem] border border-slate-50 mb-6 shadow-sm" /> : <a href={doc.content} target="_blank" rel="noreferrer" className="block p-6 bg-slate-900 text-white rounded-3xl text-center font-bold text-sm mb-6 flex items-center justify-center space-x-2"><i className="fas fa-link text-orange-500"></i><span>開啟文件連結</span></a>}
                                        <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">{doc.date}</p>
                                    </GlassCard>
                                ))}
                            </div>
                        )}

                        {view === 'checklist' && (
                            <div className="space-y-4">
                                {(activeTrip.checklist || []).map(i => (
                                    <GlassCard key={i.id} className={`p-6 flex justify-between items-center group ${i.checked ? 'bg-slate-50 opacity-60' : 'bg-white'}`} onClick={() => updateActiveTrip({...activeTrip, checklist: activeTrip.checklist.map(c=>c.id===i.id?{...c, checked:!c.checked}:c)})}>
                                        <div className="flex items-center cursor-pointer flex-1"><div className={`w-10 h-10 rounded-2xl border-2 flex items-center justify-center mr-6 transition-all ${i.checked ? 'bg-orange-500 border-orange-500 shadow-xl' : 'bg-white border-slate-200'}`}>{i.checked && <i className="fas fa-check text-white text-sm"></i>}</div><span className={`text-xl font-bold ${i.checked ? 'line-through text-slate-300' : 'text-slate-800'}`}>{i.item}</span></div>
                                        <div className="flex space-x-4 opacity-0 group-hover:opacity-100 transition-all" onClick={e => e.stopPropagation()}>
                                            <button onClick={() => { setEditingItem(i); setIsFormModalOpen(true); }} className="text-slate-300 hover:text-orange-500"><i className="fas fa-pencil-alt"></i></button>
                                            <button onClick={() => updateActiveTrip({...activeTrip, checklist: activeTrip.checklist.filter(c=>c.id!==i.id)})} className="text-slate-200 hover:text-red-400"><i className="fas fa-trash-alt"></i></button>
                                        </div>
                                    </GlassCard>
                                ))}
                            </div>
                        )}
                    </div>
                );
            };

            return (
                <div className="max-w-5xl mx-auto min-h-screen pt-12 px-4 sm:px-8 pb-32">
                    <header className="flex flex-col sm:flex-row justify-between items-center mb-16 gap-8">
                        <div onClick={() => {setActiveTripId(null); setView('home');}} className="cursor-pointer group">
                            <h1 className="text-3xl font-black italic tracking-tighter text-slate-900 uppercase">Travel<span className="text-orange-500">Master</span></h1>
                        </div>
                        {activeTripId && (
                            <div className="flex items-center space-x-3 bg-white p-3 rounded-[2.5rem] shadow-sm border border-slate-100">
                                <button onClick={() => {setActiveTripId(null); setSelectedDateTab('');}} className="px-6 py-2.5 bg-slate-900 text-white rounded-2xl font-black text-[10px] uppercase tracking-widest active:scale-95 transition-all">Back</button>
                                <nav className="flex space-x-1 border-l border-slate-100 pl-3">
                                    {[{v:'home', i:'home'}, {v:'itinerary', i:'calendar-alt'}, {v:'accounting', i:'receipt'}, {v:'shopping', i:'shopping-bag'}, {v:'documents', i:'folder-open'}, {v:'checklist', i:'check-circle'}].map(btn => (
                                        <button key={btn.v} onClick={() => setView(btn.v)} className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-all ${view === btn.v ? 'bg-orange-500 text-white shadow-xl shadow-orange-100' : 'text-slate-400 hover:bg-slate-50'}`}><i className={`fas fa-${btn.i} text-lg`}></i></button>
                                    ))}
                                </nav>
                            </div>
                        )}
                    </header>

                    <main>{!activeTripId ? renderTripList() : renderActiveView()}</main>

                    {activeTripId && view === 'home' && (
                        <div className="fixed bottom-12 left-1/2 -translate-x-1/2 z-[100] w-full max-w-xs px-4">
                            <PrimaryButton className="w-full flex items-center justify-center space-x-4 shadow-2xl rounded-[2.5rem] py-5" onClick={() => { setView('itinerary'); showToast('開始規劃冒險行程'); }}>
                                <i className="fas fa-feather-pointed text-xl"></i><span className="text-xl tracking-tight">規劃旅程</span>
                            </PrimaryButton>
                        </div>
                    )}

                    <CustomToast message={toast.msg} visible={toast.visible} />

                    {/* 新增計畫 Modal */}
                    {isAddTripOpen && (
                        <div className="fixed inset-0 bg-slate-900/40 z-[300] flex items-center justify-center p-4 backdrop-blur-sm" onClick={() => setIsAddTripOpen(false)}>
                            <div className="bg-white w-full max-w-md rounded-[3.5rem] shadow-2xl p-10 animate-fade-in" onClick={e => e.stopPropagation()}>
                                <h2 className="text-2xl font-black text-slate-800 mb-8 text-center uppercase tracking-tighter">New Project</h2>
                                <div className="space-y-6">
                                    <input id="new-trip-title" className="w-full p-6 bg-slate-50 rounded-[2rem] font-black text-xl text-black" placeholder="旅程名稱" autoFocus />
                                    <input id="new-trip-date" type="date" className="w-full p-6 bg-slate-50 rounded-[2rem] font-black text-lg text-black" defaultValue={new Date().toISOString().split('T')[0]} />
                                    <div className="flex space-x-3 pt-6">
                                        <button onClick={() => setIsAddTripOpen(false)} className="flex-1 p-5 text-slate-400 font-bold hover:bg-slate-50 rounded-2xl transition-all">取消</button>
                                        <button onClick={() => {
                                            const title = document.getElementById('new-trip-title').value;
                                            const date = document.getElementById('new-trip-date').value;
                                            if(!title) return;
                                            const newTrip = createNewTripTemplate(title, date);
                                            updateAppState({ ...appState, trips: [...(appState.trips || []), newTrip] });
                                            setActiveTripId(newTrip.id); setIsAddTripOpen(false); showToast('旅程已建立！');
                                        }} className="flex-1 bg-slate-900 text-white font-black rounded-3xl py-5 shadow-xl active:scale-95 transition-all">建立</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}

                    <ModalWrapper isOpen={isFormModalOpen} onClose={() => setIsFormModalOpen(false)} title={`${editingItem ? '編輯' : '新增'}項目`}>
                        <ItemFormContent view={view} activeTrip={activeTrip} onUpdate={updateActiveTrip} onClose={() => setIsFormModalOpen(false)} showToast={showToast} editItem={editingItem} />
                    </ModalWrapper>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>